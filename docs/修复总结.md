# å‰åç«¯æ•°æ®ä¸ä¸€è‡´ä¿®å¤æ€»ç»“

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. åç«¯èŠ‚ç‚¹åç§°æå–å¢å¼º

**æ–‡ä»¶**: `functions/[[path]].ts`  
**ä½ç½®**: ç¬¬ 1447-1530 è¡Œ  
**æ–¹æ³•**: `extractName(link: any)`

#### ä¿®å¤å†…å®¹

**ä¿®å¤å‰**:
```javascript
extractName(link: any) {
  try {
    const hashIndex = link.lastIndexOf('#');
    if (hashIndex !== -1) return decodeURIComponent(link.substring(hashIndex + 1));
    
    // ä»…ç‰¹æ®Šå¤„ç† vmess
    if (link.startsWith('vmess://')) {
      const config = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(link.substring(8)), c => c.charCodeAt(0))));
      return config.ps || '';
    }
  } catch (e) { }
  return '';  // âŒ å…¶ä»–åè®®è¿”å›ç©ºå­—ç¬¦ä¸²
}
```

**ä¿®å¤å**:
```javascript
extractName(link: any) {
  try {
    // 1. ä¼˜å…ˆä» # æå–
    const hashIndex = link.lastIndexOf('#');
    if (hashIndex !== -1 && hashIndex < link.length - 1) {
      const name = decodeURIComponent(link.substring(hashIndex + 1));
      if (name.trim()) return name.trim();
    }

    // 2. æ”¯æŒæ‰€æœ‰åè®®
    if (link.startsWith('vmess://')) { /* VMess å¤„ç† */ }
    if (link.startsWith('vless://')) { /* VLESS å¤„ç† */ }
    if (link.startsWith('trojan://')) { /* Trojan å¤„ç† */ }
    if (link.startsWith('ss://')) { /* Shadowsocks å¤„ç† */ }
    if (link.match(/^(hysteria2?|hy2?):\\/\\//)) { /* Hysteria å¤„ç† */ }
    if (link.startsWith('tuic://')) { /* TUIC å¤„ç† */ }
    if (link.startsWith('socks5://')) { /* Socks5 å¤„ç† */ }

    // 3. é»˜è®¤è¿”å›æœ‰æ„ä¹‰çš„å€¼
    const protocolMatch = link.match(/^([^:]+):/);
    if (protocolMatch) {
      return protocolMatch[1].toUpperCase() + ' èŠ‚ç‚¹';
    }
  } catch (e) {
    console.warn('extractName failed for link:', link, e);
  }
  
  return 'æœªçŸ¥èŠ‚ç‚¹';  // âœ… è¿”å›æœ‰æ„ä¹‰çš„é»˜è®¤å€¼
}
```

#### æ”¹è¿›ç‚¹

1. âœ… **å®Œæ•´æ€§æ£€æŸ¥**: éªŒè¯ `#` åé¢ç¡®å®æœ‰å†…å®¹
2. âœ… **åè®®æ”¯æŒ**: ä» 1 ç§æ‰©å±•åˆ° 7+ ç§
3. âœ… **æœåŠ¡å™¨åœ°å€æå–**: æ”¯æŒä»å„ç§æ ¼å¼ä¸­æå–æœåŠ¡å™¨åœ°å€
4. âœ… **é”™è¯¯å¤„ç†**: æ·»åŠ  console.warn å¸®åŠ©è°ƒè¯•
5. âœ… **é»˜è®¤å€¼**: è¿”å›æœ‰æ„ä¹‰çš„é»˜è®¤å€¼è€Œéç©ºå­—ç¬¦ä¸²

---

### 2. å‰ç«¯èŠ‚ç‚¹åç§°æå–å¢å¼º

**æ–‡ä»¶**: `src/lib/subscription-parser.ts`  
**ä½ç½®**: ç¬¬ 548-655 è¡Œ  
**æ–¹æ³•**: `extractNodeNameFromUrl(url: string)`

#### ä¿®å¤å†…å®¹

**ä¸»è¦æ”¹è¿›**:

1. âœ… **ä¼˜å…ˆçº§è°ƒæ•´**: `#` åç§°ä¼˜å…ˆçº§æœ€é«˜
2. âœ… **æ–°å¢åè®®**: hysteriaã€hysteria2ã€hyã€hy2ã€tuicã€socks5
3. âœ… **æ­£åˆ™æ”¹è¿›**: ä½¿ç”¨ `[^:?#]+` æ›´å‡†ç¡®åœ°åŒ¹é…æœåŠ¡å™¨åœ°å€
4. âœ… **SS å¢å¼º**: æ”¯æŒ `@server` æ ¼å¼çš„ Shadowsocks
5. âœ… **é™çº§å¤„ç†**: å¤šå±‚é™çº§ç­–ç•¥ç¡®ä¿æ€»èƒ½æå–åˆ°åç§°

#### æ–°å¢åè®®æ”¯æŒ

| åè®® | æå–æ–¹å¼ | ç¤ºä¾‹ |
|------|---------|------|
| hysteria | ä» URL æå–æœåŠ¡å™¨ | `hysteria://server.com:443` â†’ `server.com` |
| hysteria2 | ä» URL æå–æœåŠ¡å™¨ | `hysteria2://server.com:443` â†’ `server.com` |
| hy | åŒ hysteria | `hy://server.com:443` â†’ `server.com` |
| hy2 | åŒ hysteria2 | `hy2://server.com:443` â†’ `server.com` |
| tuic | ä» `@` åæå– | `tuic://uuid:pass@server.com:443` â†’ `server.com` |
| socks5 | æ”¯æŒæœ‰/æ— è®¤è¯ | `socks5://user:pass@server.com:1080` â†’ `server.com` |

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### èŠ‚ç‚¹åç§°æå–æµ‹è¯•

| èŠ‚ç‚¹é“¾æ¥ | ä¿®å¤å‰ï¼ˆåç«¯ï¼‰ | ä¿®å¤åï¼ˆåç«¯ï¼‰ | çŠ¶æ€ |
|---------|--------------|--------------|------|
| `vless://uuid@sg.com:443` | `""` | `"sg.com"` | âœ… ä¿®å¤ |
| `trojan://pass@jp.com:443` | `""` | `"jp.com"` | âœ… ä¿®å¤ |
| `ss://base64@us.com:443` | `""` | `"us.com"` | âœ… ä¿®å¤ |
| `hysteria2://hy2.com:443` | `""` | `"hy2.com"` | âœ… æ–°å¢ |
| `tuic://uuid:pass@tuic.com:443` | `""` | `"tuic.com"` | âœ… æ–°å¢ |
| `socks5://socks.com:1080` | `""` | `"socks.com"` | âœ… æ–°å¢ |
| `vmess://base64#HK` | `"HK"` | `"HK"` | âœ… ä¿æŒ |

### è¿‡æ»¤è§„åˆ™åº”ç”¨æµ‹è¯•

**è¿‡æ»¤è§„åˆ™**: `é¦™æ¸¯|HK|æ—¥æœ¬|JP`

**èŠ‚ç‚¹åˆ—è¡¨**:
```
1. vmess://...#é¦™æ¸¯-01
2. vless://uuid@hk.example.com:443
3. trojan://pass@jp.test.com:443
4. ss://base64@sg.proxy.com:443#Singapore
```

| èŠ‚ç‚¹ | ä¿®å¤å‰ï¼ˆåç«¯ï¼‰ | ä¿®å¤åï¼ˆåç«¯ï¼‰ | é¢„æœŸ |
|-----|--------------|--------------|------|
| 1 | âŒ è¿‡æ»¤ï¼ˆæ­£ç¡®ï¼‰ | âŒ è¿‡æ»¤ï¼ˆæ­£ç¡®ï¼‰ | âŒ |
| 2 | â“ ä¸ç¡®å®šï¼ˆåç§°ä¸ºç©ºï¼‰ | âœ… ä¿ç•™ï¼ˆæœåŠ¡å™¨åœ°å€ä¸åŒ¹é…ï¼‰ | âœ… |
| 3 | â“ ä¸ç¡®å®šï¼ˆåç§°ä¸ºç©ºï¼‰ | âŒ è¿‡æ»¤ï¼ˆæœåŠ¡å™¨åœ°å€åŒ¹é… "JP"ï¼‰ | âŒ |
| 4 | âœ… ä¿ç•™ï¼ˆæ­£ç¡®ï¼‰ | âœ… ä¿ç•™ï¼ˆæ­£ç¡®ï¼‰ | âœ… |

**ç»“è®º**: ä¿®å¤åè¿‡æ»¤è§„åˆ™è¡Œä¸ºç¡®å®šä¸”ç¬¦åˆé¢„æœŸ âœ…

---

## ğŸ¯ è§£å†³çš„é—®é¢˜

### é—®é¢˜ 1: è¿‡æ»¤è§„åˆ™å¯¹æŸäº›åè®®æ— æ•ˆ

**è¡¨ç°**:
- VLESSã€Trojanã€SS ç­‰èŠ‚ç‚¹è®¾ç½®è¿‡æ»¤è§„åˆ™åä»ç„¶å‡ºç°åœ¨ç»“æœä¸­

**åŸå› **:
- åç«¯ `extractName` æ— æ³•æå–è¿™äº›åè®®çš„åç§°ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
- è¿‡æ»¤é€»è¾‘ä¸­ `nameRegex.test('')` æ€»æ˜¯è¿”å› `false`

**ä¿®å¤**:
- ç°åœ¨æ‰€æœ‰åè®®éƒ½èƒ½æ­£ç¡®æå–åç§°
- è¿‡æ»¤è§„åˆ™èƒ½æ­£ç¡®åŒ¹é…èŠ‚ç‚¹åç§°æˆ–æœåŠ¡å™¨åœ°å€

### é—®é¢˜ 2: èŠ‚ç‚¹é¢„è§ˆæ˜¾ç¤ºç©ºç™½åç§°

**è¡¨ç°**:
- åœ¨èŠ‚ç‚¹è¯¦æƒ…æ¨¡æ€æ¡†ä¸­ï¼ŒæŸäº›èŠ‚ç‚¹æ˜¾ç¤ºä¸ºç©ºç™½

**åŸå› **:
- å‰ç«¯è°ƒç”¨ `extractNodeNameFromUrl` æ—¶ï¼Œéƒ¨åˆ†åè®®è¿”å›é»˜è®¤çš„é€šç”¨åç§°

**ä¿®å¤**:
- ä¼˜å…ˆä» `#` æå–åç§°
- é™çº§åˆ°æœåŠ¡å™¨åœ°å€
- æœ€åæ‰ä½¿ç”¨é€šç”¨åç§°

### é—®é¢˜ 3: å‰åç«¯èŠ‚ç‚¹æ•°é‡ä¸ä¸€è‡´

**è¡¨ç°**:
- å‰ç«¯æ˜¾ç¤º 10 ä¸ªèŠ‚ç‚¹ï¼Œåç«¯ç”Ÿæˆé“¾æ¥åªæœ‰ 7 ä¸ª

**åŸå› **:
- åç«¯è¿‡æ»¤æ—¶å› åç§°æå–å¤±è´¥ï¼Œå¯¼è‡´éé¢„æœŸçš„è¿‡æ»¤ç»“æœ

**ä¿®å¤**:
- å‰åç«¯ç°åœ¨ä½¿ç”¨ä¸€è‡´çš„åç§°æå–é€»è¾‘
- è¿‡æ»¤ç»“æœä¸€è‡´

---

## âš ï¸ æ½œåœ¨å½±å“

### 1. è¿‡æ»¤è¡Œä¸ºå˜åŒ–

**å½±å“ç”¨æˆ·**: å·²é…ç½®è¿‡æ»¤è§„åˆ™çš„ç”¨æˆ·

**å…·ä½“å˜åŒ–**:
- ä¹‹å‰å› ä¸ºåç§°æå–å¤±è´¥è€Œ"æ„å¤–ä¿ç•™"çš„èŠ‚ç‚¹ï¼Œç°åœ¨å¯èƒ½è¢«æ­£ç¡®è¿‡æ»¤
- ä¹‹å‰å› ä¸ºåç§°æå–å¤±è´¥è€Œ"æ„å¤–è¿‡æ»¤"çš„èŠ‚ç‚¹ï¼Œç°åœ¨å¯èƒ½è¢«æ­£ç¡®ä¿ç•™

**ç¤ºä¾‹**:
```
è¿‡æ»¤è§„åˆ™: é¦™æ¸¯

èŠ‚ç‚¹: trojan://pass@hk.test.com:443

ä¿®å¤å‰: ä¿ç•™ï¼ˆå› ä¸ºåç§°ä¸ºç©ºï¼Œregex ä¸åŒ¹é…ï¼‰
ä¿®å¤å: å¯èƒ½è¢«è¿‡æ»¤ï¼ˆå¦‚æœç”¨æˆ·æœŸæœ›è¿‡æ»¤åŒ…å« "hk" çš„æœåŠ¡å™¨ï¼‰
```

**å»ºè®®**:
- æ£€æŸ¥ç°æœ‰çš„è¿‡æ»¤è§„åˆ™
- æµ‹è¯•è¿‡æ»¤ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸ
- å¦‚æœ‰éœ€è¦ï¼Œè°ƒæ•´è¿‡æ»¤è§„åˆ™

### 2. é»˜è®¤åç§°å˜åŒ–

**å½±å“**:
- ä¹‹å‰è¿”å›ç©ºå­—ç¬¦ä¸²çš„èŠ‚ç‚¹ï¼Œç°åœ¨ä¼šæ˜¾ç¤ºæœåŠ¡å™¨åœ°å€æˆ–åè®®å

**ç¤ºä¾‹**:
```
èŠ‚ç‚¹: vless://uuid@example.com:443

ä¿®å¤å‰æ˜¾ç¤º: ""ï¼ˆç©ºï¼‰
ä¿®å¤åæ˜¾ç¤º: "example.com"
```

**å½±å“**: æ­£é¢ï¼Œæå‡ç”¨æˆ·ä½“éªŒ âœ…

---

## ğŸ“ åç»­å»ºè®®

### ç«‹å³è¡ŒåŠ¨

1. âœ… **å·²å®Œæˆ**: åº”ç”¨ä¿®å¤è¡¥ä¸
2. ğŸ”² **å¾…å®Œæˆ**: è¿è¡Œæµ‹è¯•éªŒè¯ä¿®å¤ï¼ˆè§ `docs/ä¿®å¤éªŒè¯æµ‹è¯•.md`ï¼‰
3. ğŸ”² **å¾…å®Œæˆ**: æ£€æŸ¥ç°æœ‰è¿‡æ»¤è§„åˆ™æ˜¯å¦éœ€è¦è°ƒæ•´

### çŸ­æœŸè®¡åˆ’ï¼ˆæœ¬å‘¨å†…ï¼‰

1. ğŸ”² æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•
2. ğŸ”² æ›´æ–°ç”¨æˆ·æ–‡æ¡£ï¼Œè¯´æ˜æ”¯æŒçš„åè®®
3. ğŸ”² ç›‘æ§ç”Ÿäº§ç¯å¢ƒï¼Œç¡®è®¤æ— å›å½’é—®é¢˜

### é•¿æœŸè®¡åˆ’ï¼ˆä¸‹ä¸ªè¿­ä»£ï¼‰

1. ğŸ”² å®æ–½å…±äº«è§£æå™¨æ–¹æ¡ˆï¼ˆè§ `docs/å‰åç«¯æ•°æ®ä¸ä¸€è‡´åˆ†æ.md`ï¼‰
2. ğŸ”² æ·»åŠ  JSON è§£ææ”¯æŒï¼ˆSing-boxï¼‰
3. ğŸ”² æ·»åŠ  Base64 é€’å½’è§£æ
4. ğŸ”² ç»Ÿä¸€å‰åç«¯æ•°æ®ç»“æ„

---

## ğŸ§ª æµ‹è¯•æ¸…å•

ä¿®å¤å®Œæˆåï¼Œè¯·å®Œæˆä»¥ä¸‹æµ‹è¯•ï¼š

### å•å…ƒæµ‹è¯•
- [ ] åç«¯ `extractName` æµ‹è¯•ï¼ˆæ‰€æœ‰åè®®ï¼‰
- [ ] å‰ç«¯ `extractNodeNameFromUrl` æµ‹è¯•ï¼ˆæ‰€æœ‰åè®®ï¼‰
- [ ] å‰åç«¯è¿”å›å€¼ä¸€è‡´æ€§æµ‹è¯•

### é›†æˆæµ‹è¯•
- [ ] åˆ›å»ºåŒ…å«å„ç§åè®®çš„æµ‹è¯•è®¢é˜…
- [ ] æµ‹è¯•è¿‡æ»¤è§„åˆ™åº”ç”¨
- [ ] æµ‹è¯•è®¢é˜…ç»„é“¾æ¥ç”Ÿæˆ
- [ ] æµ‹è¯•èŠ‚ç‚¹é¢„è§ˆæ˜¾ç¤º

### å›å½’æµ‹è¯•
- [ ] ç°æœ‰è®¢é˜…ä»èƒ½æ­£å¸¸å·¥ä½œ
- [ ] ç°æœ‰è¿‡æ»¤è§„åˆ™ä»èƒ½æ­£å¸¸å·¥ä½œ
- [ ] è®¢é˜…é“¾æ¥ç”Ÿæˆæ­£å¸¸
- [ ] èŠ‚ç‚¹è®¡æ•°å‡†ç¡®

### ç”¨æˆ·éªŒæ”¶æµ‹è¯•
- [ ] åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- [ ] é‚€è¯·ç”¨æˆ·æµ‹è¯•
- [ ] æ”¶é›†åé¦ˆ

---

## ğŸ“„ ç›¸å…³æ–‡æ¡£

1. **åˆ†ææ–‡æ¡£**: `docs/å‰åç«¯æ•°æ®ä¸ä¸€è‡´åˆ†æ.md`
   - è¯¦ç»†çš„é—®é¢˜åˆ†æ
   - å®Œæ•´çš„è§£å†³æ–¹æ¡ˆ

2. **å¿«é€Ÿä¿®å¤**: `docs/å¿«é€Ÿä¿®å¤è¡¥ä¸.md`
   - ç´§æ€¥ä¿®å¤æ­¥éª¤
   - ä»£ç å¯¹æ¯”

3. **æµ‹è¯•ç”¨ä¾‹**: `docs/ä¿®å¤éªŒè¯æµ‹è¯•.md`
   - è¯¦ç»†çš„æµ‹è¯•åœºæ™¯
   - æµ‹è¯•è„šæœ¬

4. **æ¶æ„åˆ†æ**: `docs/è®¢é˜…ç³»ç»Ÿæ¶æ„åˆ†æ.md`
   - ç³»ç»Ÿæ•´ä½“æ¶æ„
   - æ•°æ®æµå‘

5. **é—®é¢˜è¯Šæ–­**: `docs/é—®é¢˜è¯Šæ–­æŒ‡å—.md`
   - å¸¸è§é—®é¢˜æ’æŸ¥
   - è°ƒè¯•æŠ€å·§

---

## ğŸ‰ ä¿®å¤æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶
1. `functions/[[path]].ts` - åç«¯è§£æå™¨
2. `src/lib/subscription-parser.ts` - å‰ç«¯è§£æå™¨

### æ–°å¢çš„æ–‡æ¡£
1. `docs/è®¢é˜…ç³»ç»Ÿæ¶æ„åˆ†æ.md`
2. `docs/å‰åç«¯æ•°æ®ä¸ä¸€è‡´åˆ†æ.md`
3. `docs/å¿«é€Ÿä¿®å¤è¡¥ä¸.md`
4. `docs/ä¿®å¤éªŒè¯æµ‹è¯•.md`
5. `docs/é—®é¢˜è¯Šæ–­æŒ‡å—.md`
6. `docs/ä¿®å¤æ€»ç»“.md`ï¼ˆæœ¬æ–‡æ¡£ï¼‰

### ä¿®å¤ç»Ÿè®¡
- **ä»£ç è¡Œæ•°**: ~150 è¡Œï¼ˆå‰åç«¯åˆè®¡ï¼‰
- **æ–°å¢åè®®æ”¯æŒ**: 6 ç§ï¼ˆhysteria, hysteria2, hy, hy2, tuic, socks5ï¼‰
- **ä¿®å¤çš„ bug**: 3 ä¸ªä¸»è¦é—®é¢˜
- **æµ‹è¯•ç”¨ä¾‹**: 10+ ä¸ª

### é¢„æœŸæ•ˆæœ
- âœ… è¿‡æ»¤è§„åˆ™å¯¹æ‰€æœ‰åè®®æœ‰æ•ˆ
- âœ… èŠ‚ç‚¹åç§°æå–æ›´å‡†ç¡®
- âœ… å‰åç«¯è¡Œä¸ºä¸€è‡´
- âœ… ç”¨æˆ·ä½“éªŒæå‡

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-12-06 14:06  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: ğŸ”² å¾…éªŒè¯  
**éƒ¨ç½²çŠ¶æ€**: ğŸ”² å¾…éƒ¨ç½²

**ä¸‹ä¸€æ­¥**: è¯·è¿è¡Œæµ‹è¯•éªŒè¯ä¿®å¤æ•ˆæœï¼ˆè§ `docs/ä¿®å¤éªŒè¯æµ‹è¯•.md`ï¼‰
