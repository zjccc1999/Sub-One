# è®¢é˜…ç»„èŠ‚ç‚¹è¶…æ—¶é—®é¢˜è¯Šæ–­

## é—®é¢˜æè¿°

- **åŸå§‹é“¾æ¥**: `https://proxyinfo.net/api/v1/client/subscribe?token=xxx`
  - å¯¼å…¥ Clash Verge: âœ… æ­£å¸¸ä½¿ç”¨
  
- **è®¢é˜…ç»„é“¾æ¥**: `https://sub.lbyan.hidns.vip/my/11f8eca0-f492-4552-8302-e27ed84d0e6f`
  - å¯¼å…¥ Clash Verge: âŒ æ‰€æœ‰èŠ‚ç‚¹è¶…æ—¶

## æ ¹æœ¬åŸå› 

**é—®é¢˜**: è®¢é˜…è½¬æ¢å™¨ä¸¢å¤±äº†å…³é”®çš„ VMess TLS é…ç½®å‚æ•°

### åŸå§‹è®¢é˜…é…ç½®ï¼ˆæ­£ç¡®ï¼‰

```yaml
- name: 'ğŸ‡­ğŸ‡° é¦™æ¸¯ (ç§»åŠ¨)'
  type: vmess
  server: hk.jiedian.stream
  port: 443
  uuid: 092526cb-4e5a-483a-ad46-e85c2ad93948
  alterId: 0
  cipher: auto
  udp: true
  tls: true
  skip-cert-verify: true
  servername: gw.alicdn.com  # â† å…³é”®ï¼TLS SNI é…ç½®
```

**å…³é”®å­—æ®µ**:
- `servername: gw.alicdn.com` - è¿™æ˜¯ TLS SNI (Server Name Indication)
- ç”¨äºä¼ªè£…å’Œç»•è¿‡å®¡æŸ¥
- **ç¼ºå°‘è¿™ä¸ªå­—æ®µä¼šå¯¼è‡´è¿æ¥è¶…æ—¶**

### ç»è¿‡è®¢é˜…è½¬æ¢å™¨åï¼ˆæ¨æµ‹ï¼‰

è®¢é˜…è½¬æ¢å™¨ï¼ˆsub.xeton.devï¼‰åœ¨è½¬æ¢æ—¶å¯èƒ½ä¸¢å¤±äº† `servername` å­—æ®µï¼š

```yaml
- name: 'ğŸ‡­ğŸ‡° é¦™æ¸¯ (ç§»åŠ¨)'
  type: vmess
  server: hk.jiedian.stream
  port: 443
  uuid: 092526cb-4e5a-483a-ad46-e85c2ad93948
  alterId: 0
  cipher: auto
  udp: true
  tls: true
  skip-cert-verify: true
  # servername: gw.alicdn.com  # â† ç¼ºå¤±ï¼å¯¼è‡´è¶…æ—¶
```

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä¸ä½¿ç”¨è®¢é˜…è½¬æ¢å™¨ï¼ˆæ¨èï¼‰

åŸå§‹è®¢é˜…**å·²ç»æ˜¯ Clash æ ¼å¼**ï¼Œä¸éœ€è¦è½¬æ¢ï¼

#### æ­¥éª¤ï¼š

1. **æ£€æŸ¥è®¢é˜…æ ¼å¼**
   
   åŸå§‹è®¢é˜…è¿”å›çš„å°±æ˜¯å®Œæ•´çš„ Clash YAML é…ç½®ï¼ŒåŒ…å«ï¼š
   - `proxies:` èŠ‚ç‚¹åˆ—è¡¨
   - `proxy-groups:` ä»£ç†ç»„
   - `rules:` è·¯ç”±è§„åˆ™

2. **ä¿®æ”¹è®¢é˜…ç»„é…ç½®**

   åœ¨è®¾ç½®ä¸­ï¼Œå°†**è®¢é˜…è½¬æ¢å™¨è®¾ç½®ä¸ºç©º**æˆ–ç¦ç”¨ï¼š

   ```
   è®¾ç½® > è®¢é˜…è½¬æ¢å™¨: ï¼ˆç•™ç©ºï¼‰
   ```

   æˆ–è€…åœ¨ä»£ç ä¸­ä¿®æ”¹é»˜è®¤è¡Œä¸ºï¼Œå¦‚æœè®¢é˜…å·²ç»æ˜¯ Clash æ ¼å¼å°±ä¸è½¬æ¢ã€‚

#### åç«¯ä¿®æ”¹ï¼ˆå¯é€‰ï¼‰

ä¿®æ”¹ `functions/[[path]].ts` ä¸­çš„é€»è¾‘ï¼Œæ£€æµ‹åˆ° Clash æ ¼å¼æ—¶è·³è¿‡è½¬æ¢ï¼š

```typescript
// åœ¨ handleSubRequest å‡½æ•°ä¸­
const combinedContent = await generateCombinedNodeList(context, config, userAgentHeader, targetSubs);

// æ£€æµ‹æ˜¯å¦å·²ç»æ˜¯ Clash æ ¼å¼
const isClashFormat = combinedContent.includes('proxies:') && 
                      combinedContent.includes('proxy-groups:');

if (targetFormat === 'clash' && isClashFormat) {
  // å·²ç»æ˜¯ Clash æ ¼å¼ï¼Œç›´æ¥è¿”å›
  return new Response(combinedContent, {
    headers: {
      'Content-Type': 'text/yaml; charset=utf-8',
      'Subscription-Userinfo': userinfo,
      'Content-Disposition': `attachment; filename*=UTF-8''${encodeURIComponent(subName)}.yaml`
    }
  });
}
```

---

### æ–¹æ¡ˆ 2: ä½¿ç”¨æ›´å¥½çš„è®¢é˜…è½¬æ¢å™¨

å¦‚æœå¿…é¡»ä½¿ç”¨è½¬æ¢å™¨ï¼ˆä¾‹å¦‚éœ€è¦åˆå¹¶å¤šä¸ªè®¢é˜…ï¼‰ï¼Œæ›´æ¢ä¸ºä¿ç•™å®Œæ•´é…ç½®çš„è½¬æ¢å™¨ï¼š

#### æ¨èè½¬æ¢å™¨ï¼š

1. **è‡ªå»ºè®¢é˜…è½¬æ¢å™¨**
   - GitHub: https://github.com/tindy2013/subconverter
   - å®Œå…¨æ§åˆ¶è½¬æ¢è§„åˆ™ï¼Œä¸ä¼šä¸¢å¤±å‚æ•°

2. **å…¶ä»–å…¬å…±è½¬æ¢å™¨**
   ```
   https://api.v1.mk/sub
   https://sub.id9.cc/sub
   ```

#### æµ‹è¯•æ–¹æ³•ï¼š

```bash
# æµ‹è¯•è½¬æ¢å™¨æ˜¯å¦ä¿ç•™ servername
curl "https://è½¬æ¢å™¨åœ°å€/sub?target=clash&url=ä½ çš„è®¢é˜…é“¾æ¥" > test.yaml

# æ£€æŸ¥æ˜¯å¦åŒ…å« servername
grep "servername" test.yaml
```

---

### æ–¹æ¡ˆ 3: ç›´æ¥ä¼ é€’ Base64 æ ¼å¼

å¦‚æœä¸éœ€è¦ Clash çš„è§„åˆ™å’Œåˆ†ç»„ï¼Œä½¿ç”¨ Base64 æ ¼å¼ï¼š

1. **ä¿®æ”¹é“¾æ¥ç”Ÿæˆå™¨**
   
   é€‰æ‹©æ ¼å¼ï¼š`Base64` è€Œä¸æ˜¯ `Clash`
   
   ```
   https://sub.lbyan.hidns.vip/my/11f8eca0-f492-4552-8302-e27ed84d0e6f?target=base64
   ```

2. **è½¬æ¢ä¸º VMess é“¾æ¥**
   
   Base64 æ ¼å¼è¿”å›çš„æ˜¯åŸå§‹çš„ vmess:// é“¾æ¥åˆ—è¡¨ï¼Œä¿ç•™æ‰€æœ‰å‚æ•°ã€‚

3. **åœ¨ Clash ä¸­æ‰‹åŠ¨é…ç½®åˆ†ç»„**ï¼ˆæ¯”è¾ƒéº»çƒ¦ï¼‰

---

## è¯Šæ–­æ­¥éª¤

### 1. ç¡®è®¤åŸå§‹è®¢é˜…æ ¼å¼

```bash
curl -H "User-Agent: ClashforWindows/0.20.39" "https://proxyinfo.net/api/v1/client/subscribe?token=xxx" | head -20
```

**é¢„æœŸè¾“å‡º**:
```yaml
mixed-port: 7890
allow-lan: true
...
proxies:
  - { name: 'ğŸ‡­ğŸ‡° é¦™æ¸¯', type: vmess, server: ..., servername: gw.alicdn.com }
```

å¦‚æœåŒ…å« `proxies:` å’Œ `proxy-groups:`ï¼Œè¯´æ˜**å·²ç»æ˜¯ Clash æ ¼å¼**ã€‚

### 2. æ£€æŸ¥è®¢é˜…ç»„é“¾æ¥è¿”å›çš„å†…å®¹

```bash
curl "https://sub.lbyan.hidns.vip/my/11f8eca0-f492-4552-8302-e27ed84d0e6f?target=clash" | grep -A 5 "name: 'ğŸ‡­ğŸ‡° é¦™æ¸¯'"
```

**æ£€æŸ¥è¦ç‚¹**:
- æ˜¯å¦æœ‰ `servername` å­—æ®µ
- æ˜¯å¦æœ‰ `tls: true`
- æ˜¯å¦æœ‰ `skip-cert-verify`

### 3. å¯¹æ¯”å·®å¼‚

```bash
# åŸå§‹è®¢é˜…
curl -H "User-Agent: ClashforWindows/0.20.39" "åŸå§‹é“¾æ¥" > original.yaml

# è®¢é˜…ç»„é“¾æ¥
curl "è®¢é˜…ç»„é“¾æ¥?target=clash" > profile.yaml

# å¯¹æ¯”ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„é…ç½®
sed -n '/proxies:/,/proxy-groups:/p' original.yaml | head -5
sed -n '/proxies:/,/proxy-groups:/p' profile.yaml | head -5
```

---

## å¿«é€Ÿä¿®å¤

### ç«‹å³å¯ç”¨çš„æ–¹æ³•

#### é€‰é¡¹ A: ç¦ç”¨è®¢é˜…è½¬æ¢å™¨

1. è¿›å…¥"è®¾ç½®"
2. æ‰¾åˆ°"è®¢é˜…è½¬æ¢å™¨"è®¾ç½®
3. æ¸…ç©ºæˆ–è®¾ç½®ä¸ºç©º
4. ä¿å­˜
5. é‡æ–°ç”Ÿæˆè®¢é˜…ç»„é“¾æ¥
6. åœ¨ Clash ä¸­é‡æ–°å¯¼å…¥

**ä¼˜ç‚¹**: ä¿ç•™æ‰€æœ‰åŸå§‹é…ç½®  
**ç¼ºç‚¹**: æ— æ³•è‡ªå®šä¹‰è§„åˆ™

#### é€‰é¡¹ B: ä½¿ç”¨ Base64 æ ¼å¼

1. åœ¨é“¾æ¥ç”Ÿæˆå™¨ä¸­é€‰æ‹©"Base64"æ ¼å¼
2. ç”Ÿæˆé“¾æ¥æ·»åŠ  `?target=base64`
3. å¯¼å…¥åˆ° Clashï¼ˆClash ä¼šè‡ªåŠ¨è¯†åˆ« vmess é“¾æ¥ï¼‰

**ä¼˜ç‚¹**: 100% ä¿ç•™åŸå§‹èŠ‚ç‚¹é…ç½®  
**ç¼ºç‚¹**: éœ€è¦æ‰‹åŠ¨é…ç½®è§„åˆ™å’Œåˆ†ç»„

---

## ä»£ç ä¿®å¤å»ºè®®

### æ£€æµ‹ Clash æ ¼å¼å¹¶è·³è¿‡è½¬æ¢

åœ¨ `functions/[[path]].ts` çš„ `handleSubRequest` å‡½æ•°ä¸­æ·»åŠ ï¼š

```typescript
// ç”Ÿæˆåˆå¹¶çš„èŠ‚ç‚¹åˆ—è¡¨
const combinedContent = await generateCombinedNodeList(context, config, userAgentHeader, targetSubs);

// æ£€æµ‹æ˜¯å¦å·²ç»æ˜¯ Clash YAML æ ¼å¼
function isClashYAML(content: string): boolean {
  const hasProxies = content.includes('proxies:');
  const hasProxyGroups = content.includes('proxy-groups:');
  const hasRules = content.includes('rules:');
  return hasProxies && (hasProxyGroups || hasRules);
}

if (targetFormat === 'clash') {
  // å¦‚æœå†…å®¹å·²ç»æ˜¯ Clash æ ¼å¼ï¼Œç›´æ¥è¿”å›
  if (isClashYAML(combinedContent)) {
    console.log('Content is already in Clash format, skipping conversion');
    return new Response(combinedContent, {
      headers: {
        'Content-Type': 'text/yaml; charset=utf-8',
        'Subscription-Userinfo': userinfo,
        'Content-Disposition': `attachment; filename*=UTF-8''${encodeURIComponent(subName)}.yaml`
      }
    });
  }
}

// å¦åˆ™ç»§ç»­ä½¿ç”¨è®¢é˜…è½¬æ¢å™¨
// ...ç°æœ‰çš„è½¬æ¢é€»è¾‘
```

---

## æ€»ç»“

### é—®é¢˜æ ¹æº

è®¢é˜…è½¬æ¢å™¨åœ¨è½¬æ¢è¿‡ç¨‹ä¸­ä¸¢å¤±äº† VMess çš„ `servername` (TLS SNI) é…ç½®ï¼Œå¯¼è‡´æ‰€æœ‰èŠ‚ç‚¹æ— æ³•å»ºç«‹ TLS è¿æ¥ï¼Œä»è€Œè¶…æ—¶ã€‚

### æœ€ä½³è§£å†³æ–¹æ¡ˆ

1. âœ… **æ¨è**: ç¦ç”¨è®¢é˜…è½¬æ¢å™¨ï¼ˆå› ä¸ºåŸå§‹è®¢é˜…å·²ç»æ˜¯ Clash æ ¼å¼ï¼‰
2. âš ï¸ **å¤‡é€‰**: æ›´æ¢ä¸ºä¿ç•™å®Œæ•´é…ç½®çš„è½¬æ¢å™¨
3. ğŸ”² **ä¸´æ—¶**: ä½¿ç”¨ Base64 æ ¼å¼ç»•è¿‡è½¬æ¢

### ç«‹å³è¡ŒåŠ¨

1. æ£€æŸ¥åŸå§‹è®¢é˜…æ˜¯å¦å·²ç»æ˜¯ Clash æ ¼å¼ï¼ˆåŒ…å« `proxies:` å’Œ `proxy-groups:`ï¼‰
2. å¦‚æœæ˜¯ï¼Œåœ¨è®¾ç½®ä¸­æ¸…ç©º"è®¢é˜…è½¬æ¢å™¨"
3. é‡æ–°ç”Ÿæˆè®¢é˜…ç»„é“¾æ¥
4. åœ¨ Clash Verge ä¸­é‡æ–°å¯¼å…¥

---

**è¯Šæ–­å®Œæˆæ—¶é—´**: 2025-12-06 14:40  
**é—®é¢˜ç±»å‹**: è®¢é˜…è½¬æ¢å™¨é…ç½®ä¸¢å¤±  
**ä¸¥é‡ç¨‹åº¦**: é«˜ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ä¸å¯ç”¨ï¼‰  
**é¢„è®¡ä¿®å¤æ—¶é—´**: 1 åˆ†é’Ÿï¼ˆç¦ç”¨è½¬æ¢å™¨ï¼‰
