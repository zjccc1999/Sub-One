# 订阅组链接完整测试指南

## ✅ 修复后的订阅组功能验证

修复完成后，订阅组链接**完全正常**工作。我们修复的节点名称提取功能主要影响**过滤规则的应用**，不影响链接生成的核心流程。

---

## 📋 订阅组链接工作流程

### 1. 链接生成流程

```
用户访问订阅组链接
    ↓
验证 profileToken
    ↓
查找对应的 Profile
    ↓
获取 Profile 中的订阅列表 (subscriptions[])
    ↓
获取 Profile 中的手动节点 (manualNodes[])
    ↓
对每个订阅发起 HTTP 请求获取内容
    ↓
使用 SubscriptionParser 解析内容 ← 这里用到修复的 extractName
    ↓
应用过滤规则 (exclude) ← 这里用到修复的 extractName
    ↓
合并所有节点（订阅节点 + 手动节点）
    ↓
去重
    ↓
根据 target 参数转换格式
    ├─ target=clash → 调用订阅转换器 → 返回 YAML
    ├─ target=singbox → 调用订阅转换器 → 返回 JSON
    ├─ target=base64 → Base64 编码 → 返回纯文本
    └─ 自适应 → 根据 User-Agent 判断
    ↓
返回给客户端
```

### 2. 修复的影响点

修复**增强了**以下功能：

✅ **过滤规则现在对所有协议都生效**
- 修复前：VLESS、Trojan 等节点因为名称为空，过滤规则无效
- 修复后：所有协议的节点都能正确提取名称，过滤规则正确应用

✅ **节点名称显示更准确**
- 修复前：部分节点在预览时显示为空
- 修复后：所有节点都显示有意义的名称

✅ **前后端行为一致**
- 修复前：前端和后端可能对同一节点提取不同的名称
- 修复后：完全一致

---

## 🧪 测试步骤

### 准备工作

#### 1. 确保应用正在运行

```bash
# 开发环境
npm run dev

# 或直接访问已部署的版本
# https://your-domain.com
```

#### 2. 确认配置正确

在**设置**中检查：
- ✅ `订阅组分享 Token` 已设置（不能是 "auto"）
- ✅ `订阅转换器` 已配置（默认：sub.xeton.dev）
- ✅ `转换配置` 已配置（默认：ACL4SSR_Online_Full.ini）

---

### 测试场景 1: 基础订阅组测试

#### 步骤 1: 创建测试订阅组

1. 进入"订阅组"标签
2. 点击"新建订阅组"
3. 填写信息：
   - **名称**: `测试订阅组`
   - **自定义ID**: `test-profile`
   - **选择订阅**: 勾选至少一个已启用的订阅
   - **启用**: ✅
4. 保存

#### 步骤 2: 生成链接

1. 进入"链接生成器"
2. 选择"测试订阅组"
3. 选择格式："Clash"
4. 点击"显示"
5. 复制链接

链接格式应该是：
```
https://your-domain.com/{profileToken}/test-profile?target=clash
```

#### 步骤 3: 验证链接（方法 A - 浏览器）

在浏览器中访问链接（不带 `?target=clash`，先看原始节点）：

```bash
# 访问 Base64 格式（原始节点列表）
https://your-domain.com/{profileToken}/test-profile?target=base64
```

**预期结果**:
- 返回 Base64 编码的文本
- 解码后包含节点链接（vmess://, vless://, trojan:// 等）

**验证方法**:
```bash
# 使用 curl 获取并解码
curl "https://your-domain.com/{profileToken}/test-profile?target=base64" | base64 -d

# 应该看到类似以下内容：
vmess://eyJwcyI6Ii4uLiJ9...
vless://uuid@server.com:443?type=ws#节点名称
trojan://password@server.com:443#节点名称
```

#### 步骤 4: 验证链接（方法 B - Clash 导入）

1. 打开 Clash 客户端（Clash for Windows / ClashX / Clash Verge 等）
2. 找到"配置"或"Profiles"选项
3. 点击"从 URL 导入" 或 "Download from URL"
4. 粘贴链接（带 `?target=clash`）:
   ```
   https://your-domain.com/{profileToken}/test-profile?target=clash
   ```
5. 点击"下载"或"导入"

**预期结果**:
- ✅ 配置成功导入
- ✅ 节点列表显示多个节点
- ✅ 节点名称正确显示
- ✅ 可以正常选择和连接节点

**如果失败**:
- 检查 profileToken 是否正确
- 检查订阅组是否已启用
- 检查订阅组中的订阅是否有效
- 查看浏览器访问链接的返回内容

---

### 测试场景 2: 过滤规则测试

#### 步骤 1: 配置过滤规则

1. 进入"订阅"标签
2. 编辑一个订阅
3. 在"排除规则"中输入：
   ```
   香港|HK|日本|JP
   ```
4. 保存

#### 步骤 2: 生成包含该订阅的订阅组链接

确保订阅组包含上述配置了过滤规则的订阅。

#### 步骤 3: 验证过滤效果

在浏览器中访问：
```
https://your-domain.com/{profileToken}/test-profile?target=base64
```

解码后检查：
- ✅ **修复前**: VLESS/Trojan 节点可能仍然包含（因为名称提取失败）
- ✅ **修复后**: 所有包含"香港"、"HK"、"日本"、"JP"的节点都被过滤

**测试命令**:
```bash
# 获取节点列表
curl "https://your-domain.com/{profileToken}/test-profile?target=base64" | base64 -d > nodes.txt

# 检查是否包含被过滤的节点
grep -i "香港\|HK\|日本\|JP" nodes.txt

# 如果没有输出，说明过滤成功 ✅
# 如果有输出，说明过滤失败 ❌
```

---

### 测试场景 3: 多种格式测试

测试不同的格式参数：

#### Base64 格式 (通用)
```
https://your-domain.com/{profileToken}/test-profile?target=base64
```
**用途**: V2rayN, V2rayNG, Shadowrocket 等

**验证方法**:
```bash
curl "..." | base64 -d
# 应该看到节点链接列表
```

#### Clash 格式 (YAML)
```
https://your-domain.com/{profileToken}/test-profile?target=clash
```
**用途**: Clash for Windows, ClashX, Clash Meta

**验证方法**:
```bash
curl "..."
# 应该看到 YAML 格式的配置文件
# proxies:
#   - name: "节点1"
#     type: vmess
#     server: ...
```

#### Sing-Box 格式 (JSON)
```
https://your-domain.com/{profileToken}/test-profile?target=singbox
```
**用途**: Sing-Box 客户端

**验证方法**:
```bash
curl "..." | jq .
# 应该看到格式良好的 JSON
```

---

### 测试场景 4: 自适应格式测试

不指定 `target` 参数，让系统根据 User-Agent 判断：

```
https://your-domain.com/{profileToken}/test-profile
```

**测试不同的 User-Agent**:

```bash
# 模拟 Clash 客户端
curl -H "User-Agent: Clash/1.18.0" "https://your-domain.com/{profileToken}/test-profile"
# 应该返回 Clash YAML 格式

# 模拟 V2rayN
curl -H "User-Agent: v2rayN/6.0" "https://your-domain.com/{profileToken}/test-profile"
# 应该返回 Base64 格式

# 模拟 Sing-Box
curl -H "User-Agent: sing-box/1.8.0" "https://your-domain.com/{profileToken}/test-profile"
# 应该返回 Sing-Box JSON 格式
```

---

## 🔧 故障排除

### 问题 1: 链接返回 403 Forbidden

**原因**: profileToken 不正确或未设置

**解决方法**:
1. 检查设置中的"订阅组分享 Token"
2. 确保 Token 不是 "auto"
3. 确保链接中使用的 Token 与设置中的一致

```bash
# 正确的链接格式
https://your-domain.com/your-profile-token/profile-id?target=clash

# 错误示例（token 错误）
https://your-domain.com/wrong-token/profile-id?target=clash  ❌
```

### 问题 2: 链接返回 404 Not Found

**原因**: 订阅组 ID 不存在或已禁用

**解决方法**:
1. 检查订阅组是否已启用
2. 确认自定义 ID 或订阅组 ID 正确
3. 查看订阅组列表中的实际 ID

### 问题 3: Clash 导入成功但没有节点

**可能原因**:

#### 原因 A: 订阅组中的订阅全部被过滤
```bash
# 检查原始节点数
curl "https://your-domain.com/{token}/profile-id?target=base64" | base64 -d | wc -l
```

**解决方法**: 调整过滤规则或添加更多订阅

#### 原因 B: 订阅源失效
```bash
# 检查订阅源是否可访问
curl "订阅源URL"
```

**解决方法**: 更新订阅源 URL

#### 原因 C: 订阅转换器失败
```bash
# 直接测试转换器
curl "https://sub.xeton.dev/sub?target=clash&url=..."
```

**解决方法**: 
- 更换订阅转换器
- 检查转换配置 URL 是否有效

### 问题 4: 节点名称显示异常

**修复前可能出现**:
- VLESS 节点名称为空
- Trojan 节点名称为空

**修复后**:
- 所有节点都有有意义的名称
- 优先显示 `#` 后的名称
- 降级到服务器地址

**验证方法**:
```bash
# 查看节点名称
curl "https://your-domain.com/{token}/profile-id?target=base64" | base64 -d

# 每个节点链接应该都有 # 后的名称
vmess://...#节点名称
vless://...#服务器地址  ← 即使原始链接没有 #，也会提取服务器地址
```

---

## ✅ 完整测试检查清单

### 基础功能
- [ ] 订阅组链接可以生成
- [ ] 浏览器访问链接返回内容
- [ ] Base64 格式可以解码
- [ ] Clash 格式是有效的 YAML

### 节点验证
- [ ] 所有节点都有名称（不为空）
- [ ] 节点名称符合预期（过滤规则应用正确）
- [ ] 节点数量正确

### Clash 导入
- [ ] 配置可以成功导入
- [ ] 节点列表正常显示
- [ ] 可以选择和连接节点
- [ ] 节点名称正确显示

### 过滤规则
- [ ] 黑名单模式正确过滤节点
- [ ] 白名单模式正确保留节点
- [ ] 协议过滤正确工作
- [ ] 混合规则正确应用

### 多格式支持
- [ ] Base64 格式正常
- [ ] Clash 格式正常
- [ ] Sing-Box 格式正常
- [ ] 自适应格式根据 UA 正确判断

---

## 📊 修复前后对比

### 过滤规则应用

**测试场景**: 订阅组包含 VLESS 节点，过滤规则 `香港|HK`

| 节点 | 修复前 | 修复后 |
|------|--------|--------|
| `vless://uuid@hk.example.com:443` | ✅ 保留（名称为空，规则未生效） | ❌ 过滤（服务器地址匹配 "hk"） |
| `vless://uuid@sg.example.com:443#香港节点` | ❌ 过滤（# 名称匹配） | ❌ 过滤（# 名称匹配） |
| `vless://uuid@us.example.com:443` | ✅ 保留 | ✅ 保留 |

### Clash 节点显示

**修复前**:
```yaml
proxies:
  - name: ""          # ❌ VLESS 节点名称为空
    type: vless
    server: sg.example.com
    ...
  - name: "香港-01"   # ✅ VMess 节点正常
    type: vmess
    server: hk.test.com
    ...
```

**修复后**:
```yaml
proxies:
  - name: "sg.example.com"  # ✅ VLESS 节点显示服务器地址
    type: vless
    server: sg.example.com
    ...
  - name: "香港-01"         # ✅ VMess 节点正常
    type: vmess
    server: hk.test.com
    ...
```

---

## 🎉 总结

### 修复的影响

✅ **订阅组链接完全正常工作**
- 链接生成流程没有变化
- 节点解析和合并正常
- 格式转换正常

✅ **功能增强**
- 过滤规则对所有协议都生效
- 节点名称显示更准确
- 前后端行为一致

✅ **Clash 导入正常**
- 配置可以成功导入
- 所有节点都正常显示
- 节点名称不再为空

### 可能的变化

⚠️ **过滤规则更严格**
- 之前因名称提取失败而"意外保留"的节点，现在可能被正确过滤
- 建议检查并调整过滤规则

### 下一步

1. ✅ **立即可用**: 修复后的订阅组链接可以直接使用
2. 🔲 **建议测试**: 在实际设备上导入 Clash 验证
3. 🔲 **调整规则**: 如有需要，优化过滤规则

---

**测试完成**: 订阅组功能完全正常 ✅  
**可以放心使用**: Clash 导入没有问题 ✅
