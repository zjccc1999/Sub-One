# è®¢é˜…ç³»ç»Ÿé—®é¢˜è¯Šæ–­æŒ‡å—

## ğŸ” å¿«é€Ÿè¯Šæ–­æµç¨‹å›¾

```
é‡åˆ°Bug
  â†“
é—®é¢˜è¡¨ç°æ˜¯ä»€ä¹ˆï¼Ÿ
  â”œâ”€ èŠ‚ç‚¹æ•°ä¸å¯¹ â†’ å‚è€ƒ [èŠ‚ç‚¹è®¡æ•°é—®é¢˜](#èŠ‚ç‚¹è®¡æ•°é—®é¢˜)
  â”œâ”€ é“¾æ¥æ— æ³•è®¿é—® â†’ å‚è€ƒ [é“¾æ¥ç”Ÿæˆé—®é¢˜](#é“¾æ¥ç”Ÿæˆé—®é¢˜)
  â”œâ”€ è¿‡æ»¤è§„åˆ™æ— æ•ˆ â†’ å‚è€ƒ [è¿‡æ»¤è§„åˆ™é—®é¢˜](#è¿‡æ»¤è§„åˆ™é—®é¢˜)
  â”œâ”€ æ ¼å¼è½¬æ¢é”™è¯¯ â†’ å‚è€ƒ [æ ¼å¼è½¬æ¢é—®é¢˜](#æ ¼å¼è½¬æ¢é—®é¢˜)
  â””â”€ å‰åç«¯æ•°æ®ä¸ä¸€è‡´ â†’ å‚è€ƒ [æ•°æ®åŒæ­¥é—®é¢˜](#æ•°æ®åŒæ­¥é—®é¢˜)
```

---

## èŠ‚ç‚¹è®¡æ•°é—®é¢˜

### ç—‡çŠ¶
- è®¢é˜…å¡ç‰‡æ˜¾ç¤ºçš„èŠ‚ç‚¹æ•°ä¸å®é™…ä¸ç¬¦
- è®¢é˜…ç»„çš„èŠ‚ç‚¹æ•°è®¡ç®—é”™è¯¯
- æ›´æ–°åèŠ‚ç‚¹æ•°ä¸å˜

### å¯èƒ½åŸå› 

#### 1. **ç¼“å­˜æœªæ›´æ–°**

**æ£€æŸ¥æ–¹æ³•**:
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
console.log('è®¢é˜…åˆ—è¡¨:', subs);
console.log('æœ€åæ›´æ–°æ—¶é—´:', sub.lastUpdated);
```

**è§£å†³æ–¹æ¡ˆ**:
```javascript
// useSubscriptions.ts
async function handleUpdateNodeCount(subId: string) {
  const subToUpdate = subscriptions.value.find(s => s.id === subId);
  
  // æ·»åŠ æ—¥å¿—
  console.log('å¼€å§‹æ›´æ–°:', subId, subToUpdate.url);
  
  try {
    const data = await fetchNodeCount(subToUpdate.url);
    console.log('è·å–åˆ°çš„æ•°æ®:', data);
    
    // ç¡®ä¿æ›´æ–°
    subToUpdate.nodeCount = data.count || 0;
    subToUpdate.userInfo = data.userInfo || null;
    subToUpdate.lastUpdated = new Date().toISOString(); // æ·»åŠ æ›´æ–°æ—¶é—´
    
    console.log('æ›´æ–°å:', subToUpdate.nodeCount);
    return true;
  } catch (error) {
    console.error('æ›´æ–°å¤±è´¥:', error);
    return false;
  }
}
```

#### 2. **åç«¯è§£æå¤±è´¥**

**æ£€æŸ¥åç«¯æ—¥å¿—**:
```javascript
// functions/[[path]].ts - /api/node_count å¤„ç†å™¨
console.log('æ¥æ”¶åˆ°è®¢é˜…URL:', subUrl);

const response = await fetch(subUrl);
const rawContent = await response.text();

console.log('åŸå§‹å†…å®¹é•¿åº¦:', rawContent.length);
console.log('å†…å®¹é¢„è§ˆ:', rawContent.substring(0, 200));

const parsed = subscriptionParser.parse(rawContent, 'test');
console.log('è§£æå‡ºçš„èŠ‚ç‚¹æ•°:', parsed.length);
```

**å¸¸è§é—®é¢˜**:
- è®¢é˜…æºè¿”å›ç©ºå†…å®¹ â†’ æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®
- ç¼–ç é—®é¢˜ â†’ æ£€æŸ¥ Base64 è§£ç æ˜¯å¦æ­£ç¡®
- æ ¼å¼ä¸æ”¯æŒ â†’ æ£€æŸ¥ subscriptionParser æ˜¯å¦æ”¯æŒè¯¥æ ¼å¼

#### 3. **è®¢é˜…ç»„è®¡ç®—é”™è¯¯**

**æ£€æŸ¥è®¡ç®—é€»è¾‘**:
```vue
<!-- ProfileCard.vue -->
<script setup>
const totalNodes = computed(() => {
  console.log('è®¡ç®—è®¢é˜…ç»„èŠ‚ç‚¹æ•°:', profile.name);
  
  let count = profile.manualNodes?.length || 0;
  console.log('æ‰‹åŠ¨èŠ‚ç‚¹:', count);
  
  profile.subscriptions?.forEach(subId => {
    const sub = subscriptions.find(s => s.id === subId);
    console.log('è®¢é˜…:', subId, 'â†’', sub?.name, 'èŠ‚ç‚¹æ•°:', sub?.nodeCount);
    
    if (sub && sub.enabled) {
      count += sub.nodeCount || 0;
    }
  });
  
  console.log('æ€»èŠ‚ç‚¹æ•°:', count);
  return count;
});
</script>
```

---

## é“¾æ¥ç”Ÿæˆé—®é¢˜

### ç—‡çŠ¶
- ç”Ÿæˆçš„é“¾æ¥æ— æ³•è®¿é—®
- é“¾æ¥è®¿é—®è¿”å› 404 æˆ– 401
- é“¾æ¥æ ¼å¼ä¸æ­£ç¡®

### è¯Šæ–­æ­¥éª¤

#### 1. **æ£€æŸ¥ Token é…ç½®**

```javascript
// å‰ç«¯ - SubscriptionLinkGeneratorCard.vue
const subLink = computed(() => {
  console.log('é€‰æ‹©çš„ID:', selectedId.value);
  console.log('config:', props.config);
  
  let token = '';
  if (selectedId.value === 'default') {
    token = props.config?.mytoken;
    console.log('ä½¿ç”¨ mytoken:', token);
  } else {
    token = props.config?.profileToken;
    console.log('ä½¿ç”¨ profileToken:', token);
  }
  
  if (!token || token === 'auto') {
    console.warn('Token æœªé…ç½®æˆ–ä¸º auto');
    return '';
  }
  
  const url = selectedId.value === 'default'
    ? `${baseUrl}/${token}`
    : `${baseUrl}/${token}/${selectedId.value}`;
  
  console.log('ç”Ÿæˆçš„é“¾æ¥:', url);
  return url;
});
```

#### 2. **åç«¯è·¯ç”±åŒ¹é…**

```javascript
// functions/[[path]].ts - handleSubRequest
console.log('è¯·æ±‚URL:', request.url);
console.log('è·¯å¾„:', url.pathname);

const pathParts = url.pathname.split('/').filter(Boolean);
console.log('è·¯å¾„éƒ¨åˆ†:', pathParts);

// pathParts[0] = token
// pathParts[1] = profileId (å¯é€‰)

const isDefaultSub = pathParts.length === 1;
console.log('æ˜¯å¦é»˜è®¤è®¢é˜…:', isDefaultSub);

if (isDefaultSub) {
  const token = pathParts[0];
  console.log('éªŒè¯é»˜è®¤è®¢é˜… token:', token);
  
  if (token !== settings.mytoken) {
    console.error('Token ä¸åŒ¹é…:', token, '!=', settings.mytoken);
    return new Response('Unauthorized', { status: 401 });
  }
} else {
  const token = pathParts[0];
  const profileId = pathParts[1];
  console.log('éªŒè¯è®¢é˜…ç»„ token:', token, 'profileId:', profileId);
  
  if (token !== settings.profileToken) {
    console.error('ProfileToken ä¸åŒ¹é…:', token, '!=', settings.profileToken);
    return new Response('Unauthorized', { status: 401 });
  }
}
```

#### 3. **è®¢é˜…ç»„æŸ¥æ‰¾**

```javascript
// æŸ¥æ‰¾è®¢é˜…ç»„
const profile = profiles.find(p => 
  p.customId === profileId || p.id === profileId
);

console.log('æŸ¥æ‰¾è®¢é˜…ç»„:', profileId);
console.log('æ‰€æœ‰è®¢é˜…ç»„:', profiles.map(p => ({ id: p.id, customId: p.customId, name: p.name })));
console.log('æ‰¾åˆ°çš„è®¢é˜…ç»„:', profile);

if (!profile) {
  console.error('è®¢é˜…ç»„ä¸å­˜åœ¨:', profileId);
  return new Response('Profile not found', { status: 404 });
}

if (!profile.enabled) {
  console.warn('è®¢é˜…ç»„å·²ç¦ç”¨:', profile.name);
  return new Response('Profile disabled', { status: 403 });
}
```

---

## è¿‡æ»¤è§„åˆ™é—®é¢˜

### ç—‡çŠ¶
- `exclude` è§„åˆ™ä¸ç”Ÿæ•ˆ
- é¢„æœŸè¢«è¿‡æ»¤çš„èŠ‚ç‚¹ä»ç„¶å‡ºç°
- è¿‡æ»¤åèŠ‚ç‚¹æ•°ä¸é¢„æœŸä¸ç¬¦

### è¯Šæ–­æ–¹æ³•

#### 1. **ç¡®è®¤è§„åˆ™åº”ç”¨ä½ç½®**

**é‡è¦**: è¿‡æ»¤è§„åˆ™**åªåœ¨é“¾æ¥ç”Ÿæˆæ—¶åº”ç”¨**ï¼Œä¸å½±å“ `nodeCount` çš„æ˜¾ç¤ºï¼

```javascript
// functions/[[path]].ts - generateCombinedNodeList

// å¤„ç† HTTP è®¢é˜…
const processedSubResults = await Promise.all(httpSubs.map(async (sub) => {
  console.log('å¤„ç†è®¢é˜…:', sub.name);
  console.log('æ’é™¤è§„åˆ™:', sub.exclude);
  
  const content = await fetch(sub.url).then(r => r.text());
  const rawNodes = subscriptionParser.parse(content, sub.name);
  console.log('è§£æå‡ºçš„åŸå§‹èŠ‚ç‚¹æ•°:', rawNodes.length);
  
  const processedNodes = subscriptionParser.processNodes(
    rawNodes,
    sub.name,
    { 
      exclude: sub.exclude,  // è¿™é‡Œåº”ç”¨è¿‡æ»¤
      prependSubName: config.prependSubName 
    }
  );
  console.log('è¿‡æ»¤åçš„èŠ‚ç‚¹æ•°:', processedNodes.length);
  
  return processedNodes;
}));
```

#### 2. **æ£€æŸ¥è¿‡æ»¤é€»è¾‘**

```javascript
// SubscriptionParser.processNodes
processNodes(nodes, subName, options = {}) {
  console.log('processNodes è¾“å…¥:', {
    nodeCount: nodes.length,
    subName,
    options
  });
  
  let result = [...nodes];
  
  // åº”ç”¨æ’é™¤è§„åˆ™
  if (options.exclude && options.exclude.trim()) {
    const excludePattern = options.exclude.trim();
    console.log('åº”ç”¨æ’é™¤è§„åˆ™:', excludePattern);
    
    const regex = new RegExp(excludePattern, 'i');
    const beforeCount = result.length;
    
    result = result.filter(node => {
      const name = this.extractName(node);
      const shouldExclude = regex.test(name);
      
      if (shouldExclude) {
        console.log('æ’é™¤èŠ‚ç‚¹:', name);
      }
      
      return !shouldExclude;
    });
    
    console.log('è¿‡æ»¤å‰:', beforeCount, 'è¿‡æ»¤å:', result.length);
  }
  
  // æ·»åŠ è®¢é˜…åå‰ç¼€
  if (options.prependSubName && subName) {
    console.log('æ·»åŠ å‰ç¼€:', subName);
    result = result.map(node => this.prependName(node, subName));
  }
  
  return result;
}
```

#### 3. **æµ‹è¯•æ­£åˆ™è¡¨è¾¾å¼**

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•
const excludePattern = 'é¦™æ¸¯|æ—¥æœ¬|ç¾å›½';
const regex = new RegExp(excludePattern, 'i');

const testNodes = [
  'é¦™æ¸¯-01',
  'æ—¥æœ¬-Tokyo',
  'æ–°åŠ å¡-SG',
  'ç¾å›½-LA'
];

testNodes.forEach(name => {
  console.log(name, 'â†’ æ˜¯å¦æ’é™¤:', regex.test(name));
});

// é¢„æœŸè¾“å‡º:
// é¦™æ¸¯-01 â†’ æ˜¯å¦æ’é™¤: true
// æ—¥æœ¬-Tokyo â†’ æ˜¯å¦æ’é™¤: true
// æ–°åŠ å¡-SG â†’ æ˜¯å¦æ’é™¤: false
// ç¾å›½-LA â†’ æ˜¯å¦æ’é™¤: true
```

---

## æ ¼å¼è½¬æ¢é—®é¢˜

### ç—‡çŠ¶
- Clash/Sing-Box æ ¼å¼æ— æ³•å¯¼å…¥
- Base64 ç¼–ç é”™è¯¯
- YAML æ ¼å¼è§£æå¤±è´¥

### è¯Šæ–­æ­¥éª¤

#### 1. **æ£€æŸ¥ target å‚æ•°**

```javascript
// åç«¯ - handleSubRequest
const targetFormat = url.searchParams.get('target');
console.log('ç›®æ ‡æ ¼å¼:', targetFormat);

if (!targetFormat || targetFormat === 'auto') {
  // è‡ªé€‚åº”ï¼šæ ¹æ® User-Agent åˆ¤æ–­
  const ua = request.headers.get('User-Agent') || '';
  console.log('User-Agent:', ua);
  
  if (ua.includes('Clash')) {
    console.log('æ£€æµ‹åˆ° Clash å®¢æˆ·ç«¯');
    targetFormat = 'clash';
  } else if (ua.includes('sing-box')) {
    console.log('æ£€æµ‹åˆ° Sing-Box å®¢æˆ·ç«¯');
    targetFormat = 'singbox';
  } else {
    console.log('é»˜è®¤ä½¿ç”¨ base64');
    targetFormat = 'base64';
  }
}
```

#### 2. **è®¢é˜…è½¬æ¢å™¨è°ƒç”¨**

```javascript
// è°ƒç”¨è®¢é˜…è½¬æ¢å™¨
const subConverterUrl = profile?.subConverter || settings.subConverter;
const subConfigUrl = profile?.subConfig || settings.subConfig;

console.log('è®¢é˜…è½¬æ¢å™¨:', subConverterUrl);
console.log('è½¬æ¢é…ç½®:', subConfigUrl);

const converterApiUrl = `https://${subConverterUrl}/sub?` + new URLSearchParams({
  target: targetFormat,
  url: encodeURIComponent(baseNodesUrl),  // Base64 ç¼–ç çš„èŠ‚ç‚¹åˆ—è¡¨
  config: encodeURIComponent(subConfigUrl),
  emoji: 'true',
  list: 'false',
  udp: 'true',
  tfo: 'false',
  scv: 'true',
  fdn: 'false',
  sort: 'false'
});

console.log('è½¬æ¢å™¨ API URL:', converterApiUrl);

try {
  const response = await fetch(converterApiUrl);
  console.log('è½¬æ¢å™¨å“åº”çŠ¶æ€:', response.status);
  
  if (!response.ok) {
    const errorText = await response.text();
    console.error('è½¬æ¢å™¨é”™è¯¯:', errorText);
    throw new Error(`Converter failed: ${response.status}`);
  }
  
  const convertedContent = await response.text();
  console.log('è½¬æ¢åå†…å®¹é•¿åº¦:', convertedContent.length);
  console.log('å†…å®¹é¢„è§ˆ:', convertedContent.substring(0, 500));
  
  return new Response(convertedContent, {
    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
  });
} catch (error) {
  console.error('è½¬æ¢å¤±è´¥:', error);
  // é™çº§åˆ° Base64
  return generateBase64Response(allNodes);
}
```

#### 3. **Base64 ç¼–ç **

```javascript
// ç”Ÿæˆ Base64 å“åº”
function generateBase64Response(nodes) {
  const content = nodes.join('\n');
  console.log('åŸå§‹å†…å®¹:', content);
  console.log('èŠ‚ç‚¹æ•°é‡:', nodes.length);
  
  // æ­£ç¡®çš„ Base64 ç¼–ç ï¼ˆæ”¯æŒ UTF-8ï¼‰
  const base64Content = btoa(
    unescape(encodeURIComponent(content))
  );
  
  console.log('Base64 å†…å®¹é•¿åº¦:', base64Content.length);
  
  return new Response(base64Content, {
    headers: {
      'Content-Type': 'text/plain;charset=utf-8',
      'Subscription-Userinfo': generateUserInfo()  // å¦‚æœæœ‰çš„è¯
    }
  });
}
```

---

## æ•°æ®åŒæ­¥é—®é¢˜

### ç—‡çŠ¶
- å‰ç«¯æ˜¾ç¤ºçš„æ•°æ®ä¸åç«¯ä¸ä¸€è‡´
- ä¿å­˜åæ•°æ®ä¸¢å¤±
- å¤šæ¬¡ä¿å­˜å¯¼è‡´æ•°æ®è¦†ç›–

### è¯Šæ–­æ–¹æ³•

#### 1. **è¿½è¸ªä¿å­˜æµç¨‹**

```javascript
// App.vue - ä¿å­˜è®¢é˜…
async function handleSaveSubs() {
  console.log('=== å¼€å§‹ä¿å­˜ ===');
  console.log('è®¢é˜…æ•°é‡:', subs.value.length);
  console.log('è®¢é˜…ç»„æ•°é‡:', profiles.value.length);
  
  // æ‰“å°éƒ¨åˆ†æ•°æ®
  console.log('è®¢é˜…ç¤ºä¾‹:', subs.value[0]);
  console.log('è®¢é˜…ç»„ç¤ºä¾‹:', profiles.value[0]);
  
  try {
    const result = await saveSubs(subs.value, profiles.value);
    console.log('ä¿å­˜ç»“æœ:', result);
    
    if (result.success) {
      console.log('âœ… ä¿å­˜æˆåŠŸ');
    } else {
      console.error('âŒ ä¿å­˜å¤±è´¥:', result.message);
    }
  } catch (error) {
    console.error('âŒ ä¿å­˜å¼‚å¸¸:', error);
  }
}
```

#### 2. **åç«¯æ¥æ”¶éªŒè¯**

```javascript
// functions/[[path]].ts - /api/subs
if (path === '/subs') {
  const requestData = await request.json();
  console.log('=== åç«¯æ¥æ”¶æ•°æ® ===');
  console.log('subs æ•°é‡:', requestData.subs?.length);
  console.log('profiles æ•°é‡:', requestData.profiles?.length);
  
  // éªŒè¯æ•°æ®
  if (!Array.isArray(requestData.subs)) {
    console.error('âŒ subs ä¸æ˜¯æ•°ç»„:', typeof requestData.subs);
    return new Response(JSON.stringify({
      success: false,
      message: 'subs å¿…é¡»æ˜¯æ•°ç»„'
    }), { status: 400 });
  }
  
  if (!Array.isArray(requestData.profiles)) {
    console.error('âŒ profiles ä¸æ˜¯æ•°ç»„:', typeof requestData.profiles);
    return new Response(JSON.stringify({
      success: false,
      message: 'profiles å¿…é¡»æ˜¯æ•°ç»„'
    }), { status: 400 });
  }
  
  console.log('æ•°æ®éªŒè¯é€šè¿‡');
  
  // ä¿å­˜åˆ° KV
  console.log('ä¿å­˜ subs åˆ° KV...');
  await env.SUB_ONE_KV.put(KV_KEY_SUBS, JSON.stringify(requestData.subs));
  
  console.log('ä¿å­˜ profiles åˆ° KV...');
  await env.SUB_ONE_KV.put(KV_KEY_PROFILES, JSON.stringify(requestData.profiles));
  
  console.log('âœ… KV ä¿å­˜å®Œæˆ');
  
  return new Response(JSON.stringify({ success: true }));
}
```

#### 3. **æ•°æ®è¯»å–éªŒè¯**

```javascript
// å‰ç«¯ - fetchInitialData
async function loadData() {
  console.log('=== åŠ è½½åˆå§‹æ•°æ® ===');
  
  const data = await fetchInitialData();
  console.log('æ¥æ”¶åˆ°çš„æ•°æ®:', data);
  
  if (!data) {
    console.error('âŒ æœªè·å–åˆ°æ•°æ®');
    return;
  }
  
  console.log('subs:', data.subs?.length, 'æ¡');
  console.log('profiles:', data.profiles?.length, 'æ¡');
  console.log('config:', data.config);
  
  // æ›´æ–°çŠ¶æ€
  subs.value = data.subs || [];
  profiles.value = data.profiles || [];
  config.value = data.config || {};
  
  console.log('âœ… æ•°æ®åŠ è½½å®Œæˆ');
}
```

---

## å‰åç«¯è§£æå™¨ä¸€è‡´æ€§æ£€æŸ¥

### é—®é¢˜æ ¹æº
å‰åç«¯æœ‰**ä¸¤ä¸ªç‹¬ç«‹çš„** `SubscriptionParser` å®ç°ï¼

**å‰ç«¯**: `src/lib/subscription-parser.ts`  
**åç«¯**: `functions/[[path]].ts` ä¸­çš„ `SubscriptionParser` ç±»

### æ£€æŸ¥æ¸…å•

#### 1. **æ”¯æŒçš„åè®®åˆ—è¡¨**

```javascript
// å‰ç«¯
supportedProtocols = [
  'ss', 'ssr', 'vmess', 'vless', 'trojan',
  'hysteria', 'hysteria2', 'hy', 'hy2',
  'tuic', 'anytls', 'socks5'
];

// åç«¯ - åº”è¯¥å®Œå…¨ä¸€è‡´
supportedProtocols = [
  'ss', 'ssr', 'vmess', 'vless', 'trojan',
  'hysteria', 'hysteria2', 'hy', 'hy2',
  'tuic', 'anytls', 'socks5'
];
```

#### 2. **è§£æé€»è¾‘å¯¹æ¯”**

ä»¥ VMess ä¸ºä¾‹ï¼š

```javascript
// å‰ç«¯ - æå–èŠ‚ç‚¹å
extractNodeNameFromUrl(url: string) {
  if (protocol === 'vmess') {
    const padded = mainPart.padEnd(mainPart.length + (4 - mainPart.length % 4) % 4, '=');
    const binaryString = atob(padded);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    const jsonString = new TextDecoder('utf-8').decode(bytes);
    const node = JSON.parse(jsonString);
    return node.ps || '';
  }
}

// åç«¯ - åº”è¯¥ä½¿ç”¨ç›¸åŒçš„é€»è¾‘
extractName(link) {
  if (link.startsWith('vmess://')) {
    const config = JSON.parse(
      new TextDecoder().decode(
        Uint8Array.from(atob(link.substring(8)), c => c.charCodeAt(0))
      )
    );
    return config.ps || '';
  }
}
```

#### 3. **ç»Ÿä¸€è§£å†³æ–¹æ¡ˆ**

**é€‰é¡¹ A**: åˆ›å»ºå…±äº«æ¨¡å—ï¼ˆæ¨èï¼‰

```
é¡¹ç›®ç»“æ„:
â”œâ”€â”€ shared/
â”‚   â””â”€â”€ subscription-parser.ts  â† å…±äº«çš„è§£æå™¨
â”œâ”€â”€ src/
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ subscription-parser.ts  â† import from shared
â””â”€â”€ functions/
    â””â”€â”€ [[path]].ts  â† import from shared
```

**é€‰é¡¹ B**: å®šæœŸåŒæ­¥ä»£ç 

æ¯æ¬¡ä¿®æ”¹æ—¶åŒæ—¶æ›´æ–°å‰åç«¯ä¸¤ä¸ªæ–‡ä»¶ï¼Œå¹¶æ·»åŠ æµ‹è¯•ç¡®ä¿ä¸€è‡´æ€§ã€‚

**é€‰é¡¹ C**: ä½¿ç”¨åç«¯ API

å‰ç«¯ä¸åšè§£æï¼Œæ‰€æœ‰è§£æéƒ½é€šè¿‡åç«¯ API å®Œæˆï¼š

```javascript
// å‰ç«¯
async function parseSubscription(url: string) {
  const response = await fetch('/api/parse_subscription', {
    method: 'POST',
    body: JSON.stringify({ url })
  });
  return response.json();
}
```

---

## å¸¸ç”¨è°ƒè¯•ä»£ç ç‰‡æ®µ

### 1. **å®Œæ•´çš„èŠ‚ç‚¹æ•°æ›´æ–°æ—¥å¿—**

```javascript
// useSubscriptions.ts
async function handleUpdateNodeCount(subId: string) {
  console.group(`ğŸ”„ æ›´æ–°èŠ‚ç‚¹æ•°: ${subId}`);
  
  const sub = subscriptions.value.find(s => s.id === subId);
  console.log('ğŸ“‹ è®¢é˜…ä¿¡æ¯:', {
    id: sub.id,
    name: sub.name,
    url: sub.url,
    currentCount: sub.nodeCount
  });
  
  try {
    console.log('ğŸŒ å‘åç«¯è¯·æ±‚èŠ‚ç‚¹æ•°...');
    const startTime = performance.now();
    
    const data = await fetchNodeCount(sub.url);
    
    const duration = performance.now() - startTime;
    console.log(`âœ… è¯·æ±‚å®Œæˆ (è€—æ—¶ ${duration.toFixed(2)}ms):`, data);
    
    sub.nodeCount = data.count || 0;
    sub.userInfo = data.userInfo || null;
    
    console.log('ğŸ“Š æ›´æ–°åèŠ‚ç‚¹æ•°:', sub.nodeCount);
    console.groupEnd();
    
    return true;
  } catch (error) {
    console.error('âŒ æ›´æ–°å¤±è´¥:', error);
    console.groupEnd();
    return false;
  }
}
```

### 2. **é“¾æ¥ç”Ÿæˆå®Œæ•´æ—¥å¿—**

```vue
<!-- SubscriptionLinkGeneratorCard.vue -->
<script setup>
const subLink = computed(() => {
  console.group('ğŸ”— ç”Ÿæˆè®¢é˜…é“¾æ¥');
  
  console.log('1ï¸âƒ£ é€‰æ‹©:', {
    type: selectedId.value === 'default' ? 'é»˜è®¤è®¢é˜…' : 'è®¢é˜…ç»„',
    id: selectedId.value,
    format: selectedFormat.value
  });
  
  const baseUrl = window.location.origin;
  console.log('2ï¸âƒ£ åŸºç¡€URL:', baseUrl);
  
  let token = '';
  if (selectedId.value === 'default') {
    token = props.config?.mytoken;
    console.log('3ï¸âƒ£ ä½¿ç”¨ mytoken:', token);
  } else {
    token = props.config?.profileToken;
    console.log('3ï¸âƒ£ ä½¿ç”¨ profileToken:', token);
  }
  
  if (!token || token === 'auto') {
    console.warn('âš ï¸ Token æœªé…ç½®');
    console.groupEnd();
    return '';
  }
  
  const url = selectedId.value === 'default'
    ? `${baseUrl}/${token}`
    : `${baseUrl}/${token}/${selectedId.value}`;
  console.log('4ï¸âƒ£ æ„å»ºè·¯å¾„:', url);
  
  const format = selectedFormat.value;
  let finalUrl = url;
  
  if (format !== 'è‡ªé€‚åº”') {
    const formatParam = FORMAT_MAPPING[format] || format.toLowerCase();
    finalUrl = `${url}?target=${formatParam}`;
    console.log('5ï¸âƒ£ æ·»åŠ æ ¼å¼å‚æ•°:', formatParam);
  }
  
  console.log('âœ… æœ€ç»ˆé“¾æ¥:', finalUrl);
  console.groupEnd();
  
  return finalUrl;
});
</script>
```

### 3. **åç«¯è¯·æ±‚æ—¥å¿—**

```javascript
// functions/[[path]].ts
async function handleSubRequest(context) {
  const { request, env } = context;
  const url = new URL(request.url);
  
  console.group('ğŸ“¥ å¤„ç†è®¢é˜…è¯·æ±‚');
  console.log('URL:', url.href);
  console.log('è·¯å¾„:', url.pathname);
  console.log('å‚æ•°:', Object.fromEntries(url.searchParams));
  console.log('UA:', request.headers.get('User-Agent'));
  
  // ... å¤„ç†é€»è¾‘
  
  console.log('ğŸ“¤ è¿”å›å†…å®¹é•¿åº¦:', responseContent.length);
  console.groupEnd();
  
  return new Response(responseContent);
}
```

---

## æ¨èçš„é—®é¢˜æŠ¥å‘Šæ ¼å¼

å½“ä½ å‘ç° bug æ—¶ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è®°å½•ä¿¡æ¯ï¼š

```markdown
## Bug æè¿°
ç®€è¦æè¿°é—®é¢˜è¡¨ç°

## å¤ç°æ­¥éª¤
1. 
2. 
3. 

## é¢„æœŸè¡Œä¸º
åº”è¯¥å‘ç”Ÿä»€ä¹ˆ

## å®é™…è¡Œä¸º
å®é™…å‘ç”Ÿäº†ä»€ä¹ˆ

## ç¯å¢ƒä¿¡æ¯
- æµè§ˆå™¨: 
- è®¢é˜…æºç±»å‹: 
- è®¢é˜…æºURL: (å¯éšè—æ•æ„Ÿä¿¡æ¯)

## ç›¸å…³æ—¥å¿—
```
ç²˜è´´æ§åˆ¶å°æ—¥å¿—
```

## è¯Šæ–­ä¿¡æ¯
- è®¢é˜…ID: 
- èŠ‚ç‚¹æ•°æ˜¾ç¤º: 
- å®é™…èŠ‚ç‚¹æ•°: 
- æ˜¯å¦é…ç½®è¿‡æ»¤è§„åˆ™: 
- è¿‡æ»¤è§„åˆ™å†…å®¹: 

## æˆªå›¾
(å¦‚æœ‰å¿…è¦)
```

è¿™æ ·å¯ä»¥å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜ï¼
